{% extends "base.html" %}
{% block title %}Create Trip{% endblock %}
{% block content %}
<h1>Create a New Trip</h1>
<form method="POST" action="{{ url_for('create_trip') }}">
    {{ form.hidden_tag() }}
	<div>
        {{ form.country.label }}
        {{ form.country(size=32, list="countryList", id="countryInput") }}
		<datalist id="countryList"></datalist>
    </div>
    <div>
        {{ form.city.label }}
        {{ form.city(size=32, list="cityList", id="cityInput") }}
		<datalist id="cityList"></datalist>
    </div>
    <div>
        {{ form.start_date.label }}
        {{ form.start_date() }}
		{% for error in form.start_date.errors %}
            <span style="color: red;">{{ error }}</span>
        {% endfor %}
    </div>
    <div>
        {{ form.end_date.label }}
        {{ form.end_date() }}
		{% for error in form.end_date.errors %}
            <span style="color: red;">{{ error }}</span>
        {% endfor %}
    </div>
    <div>
        {{ form.submit() }}
    </div>
</form>

<script>
	const countryList = document.getElementById('countryList');
	fetch('/static/json/countries.json')
		.then(response => response.json())
		.then(data => {
	// Split the string into an array of countries
		data.forEach(country => {
			const listItem = document.createElement('option');
			listItem.value = country;
			countryList.appendChild(listItem);
		})});
		
	const countryInput = document.getElementById('countryInput');
	const cityInput = document.getElementById('cityInput');
	
	countryInput.addEventListener('blur', function(event) {
		const selectedCountry = event.target.value;
		const countryListItem = Array.from(countryList.getElementsByTagName('option')).find(opt => opt.value === selectedCountry.trim());
		if (!countryListItem) {
			alert("'" + selectedCountry + "' is not a valid country!");
			countryInput.value = '';
		} else {
			cityInput.value = "";
		}
	});
	cityInput.addEventListener('focus', function(event) {
		if (countryInput.value === '') {
			alert("Select a valid country first!");
			countryInput.focus();
		} else {
			const cityList = document.getElementById('cityList');
			fetch('/static/json/cities.json')
				.then(response => response.json())
				.then(data => {
				cityList.innerHTML = "";
				data[countryInput.value].forEach(country => {
					const listItem = document.createElement('option');
					listItem.value = country;
					cityList.appendChild(listItem);
			})});
		}
	});
	cityInput.addEventListener('blur', function(event) {
		const selectedCity = event.target.value;
		if (selectedCity === "") return;
		const cityListItem = Array.from(cityList.getElementsByTagName('option')).find(opt => opt.value === selectedCity.trim());
		if (!cityListItem) {
			alert("'" + selectedCity + "' is not a valid city!");
			cityInput.value = '';
		}
	});
</script>

{% endblock %}
